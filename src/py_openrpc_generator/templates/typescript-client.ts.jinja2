/**
 * {{ info.title }}
 * {{ info.description }}
 * Version: {{ info.version }}
 *
 * Auto-generated by py-openrpc-generator
 */

// ============================================================================
// Type Definitions
// ============================================================================

{{ type_definitions }}

// ============================================================================
// JSON-RPC Infrastructure
// ============================================================================

interface JsonRpcRequest {
  jsonrpc: "2.0";
  method: string;
  params?: any;
  id: number | string;
}

interface JsonRpcResponse<T = any> {
  jsonrpc: "2.0";
  result?: T;
  error?: {
    code: number;
    message: string;
    data?: any;
  };
  id: number | string;
}

// ============================================================================
// Error Classes
// ============================================================================

/**
 * Base class for JSON-RPC errors
 */
export class JsonRpcError extends Error {
  constructor(
    public code: number,
    message: string,
    public data?: any
  ) {
    super(`JSON-RPC Error ${code}: ${message}`);
    this.name = "JsonRpcError";
  }
}

{% if error_types %}
/**
 * Application-specific error classes
 */
{% for error in error_types %}
/**
 * Error {{ error.code }}: {{ error.message }}
 */
export class {{ error.class_name }} extends JsonRpcError {
  constructor(data?: any) {
    super({{ error.code }}, "{{ error.message }}", data);
    this.name = "{{ error.class_name }}";
  }
}

{% endfor %}
{% endif %}

/**
 * Parse JSON-RPC error and throw appropriate error class
 */
function createJsonRpcError(code: number, message: string, data?: any): JsonRpcError {
  {% if error_types %}
  switch (code) {
    {% for error in error_types %}
    case {{ error.code }}:
      return new {{ error.class_name }}(data);
    {% endfor %}
    default:
      return new JsonRpcError(code, message, data);
  }
  {% else %}
  return new JsonRpcError(code, message, data);
  {% endif %}
}

// ============================================================================
// {{ class_name }}
// ============================================================================

export class {{ class_name }} {
  private url: string;
  private requestId: number = 0;

  constructor(url{% if default_server_url %}?: string{% endif %}) {
    {% if default_server_url %}
    this.url = url || "{{ default_server_url }}";
    {% else %}
    this.url = url;
    {% endif %}
  }

  private async request<T = any>(method: string, params?: any): Promise<T> {
    const id = ++this.requestId;
    const body: JsonRpcRequest = {
      jsonrpc: "2.0",
      method,
      params,
      id,
    };

    const response = await fetch(this.url, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(body),
    });

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    const data: JsonRpcResponse<T> = await response.json();

    if (data.error) {
      throw createJsonRpcError(data.error.code, data.error.message, data.error.data);
    }

    return data.result as T;
  }

  private notify(method: string, params?: any): void {
    const body: JsonRpcRequest = {
      jsonrpc: "2.0",
      method,
      params,
      id: 0, // Notification uses id 0 or can be omitted
    };

    // Fire and forget - no need to wait for response
    fetch(this.url, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(body),
    }).catch(() => {
      // Silently ignore errors for notifications
    });
  }

{% if has_tags %}
  // ==========================================================================
  // API Methods (organized by tags)
  // ==========================================================================
{% for tag_name, tag_methods in methods_by_tag.items() %}

  // --------------------------------------------------------------------------
  // {{ tag_name }}
  // --------------------------------------------------------------------------
{% for method in tag_methods %}

  /**
   * {{ method.summary or method.name }}
{% if method.description %}   *
   * {{ method.description }}
{% endif %}
{% if method.deprecated %}   * @deprecated This method is deprecated
{% endif %}
{% if method.params %}   * @param params - Method parameters{% if method.is_positional %} (positional){% endif %}
{% for param in method.params %}   *   - {{ param.name }}{% if not param.required %} (optional){% endif %}: {{ param.description or 'No description' }}{% if param.deprecated %} [DEPRECATED]{% endif %}
{% endfor %}
{% endif %}
{% if method.result and method.result.description %}   * @returns {{ method.result.description }}
{% endif %}
{% if method.errors %}   * @throws { {% for error in method.errors %}{{ error.code }}{% if not loop.last %}, {% endif %}{% endfor %} }
{% endif %}
{% if method.external_docs %}   * @see {{ method.external_docs.url }}
{% endif %}
   */
  {% if method.deprecated %}/** @deprecated */
  {% endif %}async {{ method.safe_name }}({% if method.has_params %}params: {{ method.params_type }}{% endif %}): Promise<{{ method.result_type }}> {
    {% if method.is_notification %}this.notify("{{ method.name }}"{% if method.has_params %}, params{% endif %});{% else %}return this.request<{{ method.result_type }}>("{{ method.name }}"{% if method.has_params %}, params{% endif %});{% endif %}
  }
{% endfor %}
{% endfor %}
{% else %}
  // ==========================================================================
  // API Methods
  // ==========================================================================
{% for method in methods %}

  /**
   * {{ method.summary or method.name }}
{% if method.description %}   *
   * {{ method.description }}
{% endif %}
{% if method.deprecated %}   * @deprecated This method is deprecated
{% endif %}
{% if method.params %}   * @param params - Method parameters{% if method.is_positional %} (positional){% endif %}
{% for param in method.params %}   *   - {{ param.name }}{% if not param.required %} (optional){% endif %}: {{ param.description or 'No description' }}{% if param.deprecated %} [DEPRECATED]{% endif %}
{% endfor %}
{% endif %}
{% if method.result and method.result.description %}   * @returns {{ method.result.description }}
{% endif %}
{% if method.errors %}   * @throws { {% for error in method.errors %}{{ error.code }}{% if not loop.last %}, {% endif %}{% endfor %} }
{% endif %}
{% if method.external_docs %}   * @see {{ method.external_docs.url }}
{% endif %}
   */
  {% if method.deprecated %}/** @deprecated */
  {% endif %}async {{ method.safe_name }}({% if method.has_params %}params: {{ method.params_type }}{% endif %}): Promise<{{ method.result_type }}> {
    {% if method.is_notification %}this.notify("{{ method.name }}"{% if method.has_params %}, params{% endif %});{% else %}return this.request<{{ method.result_type }}>("{{ method.name }}"{% if method.has_params %}, params{% endif %});{% endif %}
  }
{% endfor %}
{% endif %}
}
